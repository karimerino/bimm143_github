---
title: "Class 14: RNASeq Mini Project"
author: "Carolina Merino PID (14484883)"
format: pdf
toc: TRUE
---

## Background


Here we work through a complete RNASeq analysis project. The input data comes from a knock-down experiment of a HOX gene. 


## Data Import


Reading the `counts` and `metadata` CSV files


```{r}
metaFile <- "GSE37704_metadata.csv"
countFile <- "GSE37704_featurecounts.csv"
colData = read.csv(metaFile, row.names=1)
countData = read.csv(countFile, row.names=1)
```

Check on data structure 

Some book-keeping is required as there looks to be a mis-match between metadata and counts columns.

```{r}
head(colData)
head(countData)

```

Looks like we need to get rid of the first "length" column of our `counts` object.

> Q. Complete the code below to remove the troublesome first column from countData

refer to `cleancounts <- countData[, -1]` of the code

```{r}
countData <- read.csv(countFile, row.names = 1)
countData[] <- lapply(countData, function(x) as.numeric(as.character(x)))
cleancounts <- as.matrix(countData[, -1])
nonzero_counts <- cleancounts[rowSums(cleancounts) > 0, ]
head(nonzero_counts)
```
>Q. Complete the code below to filter countData to exclude genes (i.e. rows) where we have 0 read count across all samples (i.e. columns).

Tip: What will rowSums() of countData return and how could you use it in this context?

```{r}
filtered_counts <- countData[rowSums(countData) > 0, ]
head(filtered_counts)

```



## DESeq Analysis


Let's begin by loading the package


```{r, message=FALSE}
library(DESeq2)
```


Now let's setup DESeq 


```{r, message=FALSE}
dds = DESeqDataSetFromMatrix(countData=nonzero_counts,
                             colData=colData,
                             design=~condition)
```

Let's run DESeq


```{r, message=FALSE}
dds <- DESeq(dds)
```


>Q. Call the summary() function on your results to get a sense of how many genes are up or down-regulated at the default 0.1 p-value cutoff.

Out of the 15,975 genes with nonzero total read count, 4,349 genes (approximately 27%) were up-regulated, and 4,396 genes (approximately 28%) were down-regulated at the default adjusted p-value cutoff of 0.1. The remaining genes either had low counts or were flagged as outliers, providing additional context from DESeq2.

And now we get the results

```{r}
res <- results(dds)
```

how many genes are up- or down-regulated at the default `alpha = 0.1`


```{r}
summary(res)

```


## Data Visualization


Volcano Plot


```{r}
library(ggplot2)


ggplot(res) +
  aes(log2FoldChange, -log(padj)) +
  geom_point()
```

Add threshold lines for fold-change and P-valye and color our subset of genes that make these threshold cut-offs in the plot.

>Q. Improve this plot by completing the below code, which adds color and axis labels



```{r}
mycols <- rep("gray", nrow(res))
mycols[abs(res$log2FoldChange) > 2] <- "blue"
mycols[ res$padj > 0.05] <- "gray"




ggplot(res) +
  aes(log2FoldChange, -log(padj)) +
  geom_point(col = mycols) +
  geom_vline(xintercept =c(-2,2), col="red") +
  geom_hline(yintercept = -log(0.05), col ="red")
```

## Add Annotation


Let's add gene symbols and entrez ids


let's install the package

```{r}
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("AnnotationDbi")
BiocManager::install("org.Hs.eg.db")

```


```{r}
library(AnnotationDbi)
library(org.Hs.eg.db)
```
>Q. Use the mapIDs() function multiple times to add SYMBOL, ENTREZID and GENENAME annotation to our results by completing the code below.

```{r}
res$symbol = mapIds(org.Hs.eg.db,
                    keys = row.names(res),
                    keytype = "ENSEMBL",
                    column = "SYMBOL",
                    multiVals = "first")


res$entrez = mapIds(org.Hs.eg.db,
                    keys = row.names(res),  
                    keytype = "ENSEMBL",
                    column = "ENTREZID",
                    multiVals = "first")


res$name = mapIds(org.Hs.eg.db,
                  keys = row.names(res),  
                  keytype = "ENSEMBL",
                  column = "GENENAME",
                  multiVals = "first")


head(res, 10)
```

>Q. Finally for this section let's reorder these results by adjusted p-value and save them to a CSV file in your current project directory.

Let's Reorder results by adjusted p-value and save as CSV file: 



```{r}
res <- res[order(res$padj), ]


write.csv(res, file = "deseq_results.csv")
```


## Pathway Analysis


### KEGG pathways 


* run this in console: `BiocManager::install( c("pathview", "gage", "gageData") )` *


Run gage analysis w/ KEGG

Install the packages for KEGG and GO first
```{r}
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install(c("gage", "gageData", "pathview"))

```


```{r, message=FALSE}
library(gage)
library(gageData)
library(pathview)
```

We need a named vector of fold-change value as input for gage.


```{r}
foldchanges <- res$log2FoldChange
names(foldchanges) <- res$entrez
head(foldchanges)
data("kegg.sets.hs")
keggres = gage(foldchanges, gsets=kegg.sets.hs)
```


```{r}
head(keggres$less, 2)
```

```{r}
pathview(pathway.id = "hsa04110", gene.data = foldchanges)
```
```{r}
library(png)
library(grid)

img <- readPNG("hsa04110.pathview.png")
grid::grid.raster(img)
```

```{r}
library(pathview)
library(png)
library(grid)

# First KEGG pathway
pathview(pathway.id = "hsa04110", gene.data = foldchanges)
img1 <- readPNG("hsa04110.pathview.png")
grid::grid.raster(img1)

# Second KEGG pathway
pathview(pathway.id = "hsa03030", gene.data = foldchanges)
img2 <- readPNG("hsa03030.pathview.png")
grid::grid.raster(img2)

```

>Q. Can you do the same procedure as above to plot the pathview figures for the top 5 down-reguled pathways?

The top 5 down-regulated pathways are: hsa00232 (Caffeine metabolism), hsa00983 (Drug metabolism – other enzymes), hsa01100 (Metabolic pathways), hsa00230 (Purine metabolism), and hsa05340 (Primary immunodeficiency). I used `pathview()` to plot these pathways, highlighting down-regulated genes in HOXA1 knockdown versus control.
```{r}
fc <- res$log2FoldChange
names(fc) <- rownames(res)

```

```{r}
keggResults <- gage(fc, gsets = kegg.sets.hs)

```

```{r}
str(keggResults)

```
```{r}
class(keggResults)
str(keggResults)

```
```{r}
# Extract the 'less' (down-regulated) matrix
downMatrix <- keggResults$less

# Convert to a data frame to make it easier to work with
downDF <- as.data.frame(downMatrix)

# Order by p-value (ascending) to get most significant
downDF <- downDF[order(downDF$p.val), ]

# Get the top 5 pathway names
top5_down <- rownames(downDF)[1:5]
top5_down

```
```{r}
# Get top 5 down-regulated pathways
top5_down <- rownames(keggres$less)[1:5]

# Extract 8-character KEGG IDs
top5_ids <- substr(top5_down, 1, 8)

# Generate Pathview plots
library(pathview)
pathview(gene.data = foldchanges, pathway.id = top5_ids, species = "hsa")

```

```{r}
setwd("C:/Users/Linda Kubera/Desktop/Bimm 143 Class/Class 14")

```

```{r}
list.files(pattern = "\\.png$")

```

```{r}
pathway_files <- c("hsa03030.pathview.png",
                   "hsa05130.pathview.png",
                   "hsa03013.pathview.png",
                   "hsa03440.pathview.png")

```


```{r}
knitr::include_graphics("hsa03030.pathview.png")

```


```{r}
knitr::include_graphics("hsa05130.pathview.png")

```


```{r}
knitr::include_graphics("hsa03013.pathview.png")

```


```{r}
knitr::include_graphics("hsa03440.pathview.png")

```









### GO terms


Same analysis but using GO genesets rather than KEGG.


```{r, message=FALSE}
data(go.sets.hs)
data(go.subs.hs)


gobpsets = go.sets.hs[go.subs.hs$BP]


gobpres = gage(foldchanges, gsets=gobpsets, same.dir=TRUE)


lapply(gobpres, head)
```
```{r}
head(gobpres$less, 4)
```

### Reactome


Lots of folkslike the reactome web interface. You can also run this as an R fucntion but lets look at the website first
 <https://reactome.org/>
 
 The website wants a text file with one gene symbol per line of the genes ypu want to map to the pathways.


```{r}
sig_genes <- res[res$padj <= 0.05 & !is.na(res$padj), "symbol"]
print(paste("Total number of significant genes:", length(sig_genes)))
```
and write out to a file: 


```{r}
write.table(sig_genes, file="significant_genes.txt", row.names=FALSE, col.names=FALSE, quote=FALSE)
```


Section 5. GO online (OPTIONAL)

>Q: What pathway has the most significant “Entities p-value”? Do the most significant pathways listed match your previous KEGG results? What factors could cause differences between the two methods?

```{r}
head(keggres$less, 5)

```
The pathway with the most significant “Entities p-value” is **hsa04110: Cell cycle** (p-value ≈ 8.99e-6).  
This matches the top pathways observed in our previous KEGG analysis / differs from the previous KEGG results.  

Possible reasons for differences include differences in statistical methods between GAGE and standard KEGG enrichment, variation in gene set coverage, multiple testing corrections, and differences in input data filtering or preprocessing.


## Save Our Results


```{r}
write.csv(res, file="myresults.csv")
```